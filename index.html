<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>⚡SBI AI</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#ffffff; --accent:#22c55e;
    --ring:#334155; --btn:#16a34a; --btnText:#ffffff; --highlight:#e67e25; --secondary:#f0f0f0;
  }
  .light-mode {
    --bg:#f8fafc;
    --card:#ffffff;
    --muted:#64748b;
    --text:#0f172a;
    --ring:#e2e8f0;
    --accent:#64748b;
    --btn:#0ea5e9;
    --btnText:#ffffff;
    --secondary:#64748b;
    --highlight:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background: var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased; line-height:1.5;
    transition: background 0.3s, color 0.3s;
  }
  .light-mode body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }
  body:not(.light-mode) {
    background: radial-gradient(1200px 800px at 20% -10%, #1e293b 0%, var(--bg) 40%, #0b1224 100%);
  }
  .header-container {
    background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(15,23,42,0.8) 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--ring);
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 12px 0;
    transition: background 0.3s, border-color 0.3s;
  }
  .light-mode .header-container {
    background: linear-gradient(180deg, rgba(248,250,252,0.95) 0%, rgba(248,250,252,0.9) 100%);
    border-bottom: 1px solid var(--ring);
  }
  .wrap{max-width:980px;margin:auto;padding:24px}
  .header-content{display:flex;align-items:center;justify-content:space-between}
  .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:1.2rem}
  .controls{display:flex;align-items:center;gap:12px}
  .icon-btn{background:rgba(51,65,85,0.5);border:none;color:var(--text);width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
  .icon-btn:hover{background:var(--ring);transform:scale(1.05)}
  .light-mode .icon-btn{background:rgba(226,232,240,0.8)}
  .light-mode .icon-btn:hover{background:rgba(203,213,225,1)}
  .lang-dropdown {
    position: relative;
    display: inline-block;
  }
  .lang-dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    top: 40px;
    background: var(--card);
    border: 1px solid var(--ring);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    z-index: 1000;
    min-width: 120px;
    transition: background 0.3s;
  }
  .lang-dropdown-content a {
    color: var(--text);
    padding: 10px 16px;
    text-decoration: none;
    display: block;
    font-size: 14px;
  }
  .lang-dropdown-content a:hover {
    background: var(--ring);
  }
  .lang-dropdown.active .lang-dropdown-content {
    display: block;
  }
  .main-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:clamp(22px,3vw,30px);margin:0;font-weight:700;letter-spacing:.2px}
  .small{font-size:12px;color:var(--muted)}
  .card{
    background:linear-gradient(180deg, var(--bg) 0%, var(--card) 100%);
    border:1px solid var(--ring); border-radius:20px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.25);
    transition: background 0.3s, border-color 0.3s;
  }
  .light-mode .card {
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    box-shadow: 0 10px 25px rgba(0,0,0,.1);
    border: 1px solid var(--ring);
  }
  .grid{display:grid; gap:12px}
  @media(min-width:720px){ .grid-2{grid-template-columns:1.1fr .9fr} }
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], textarea, select, input[type="file"]{
    width:100%; background:#0b1224; color:var(--text); border:1px solid var(--ring);
    border-radius:12px; padding:12px 14px; outline:none; transition:.2s;
  }
  .light-mode input[type="text"], .light-mode textarea, .light-mode select, .light-mode input[type="file"] {
    background: #FFFFFF;
    border: 1px solid var(--ring);
    color: var(--text);
  }
  textarea{min-height:130px; resize:vertical}
  input:focus, textarea:focus, select:focus{border-color:var(--secondary); box-shadow:0 0 0 3px rgba(59,130,246,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}
  .btn{
    background:linear-gradient(180deg,var(--accent),#16a34a); border:0; color:var(--btnText); padding:12px 16px;
    border-radius:12px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
    transition:transform .06s ease; box-shadow:0 8px 18px rgba(34,197,94,.25);
  }
  .btn:active{transform:translateY(1px)}
  .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .ghost{background:transparent; color:var(--text); border:1px dashed var(--ring)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .out{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; line-height:1.6}

  #output {
    min-height:220px;
    border: none;
    border-radius:12px;
    padding:16px;
    background:var(--card);
  }

  .light-mode #output {
    background: var(--card);
    border: none;
    color: var(--text);
  }

  .muted{color:var(--muted)}
  .spinner{width:18px;height:18px;border:3px solid transparent;border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .footer{margin-top:10px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .tip{font-size:12px;color:var(--muted)}
  .pill{padding:6px 10px;border:1px solid var(--ring);border-radius:999px;cursor:pointer}
  .right{justify-content:flex-end}
  .response-footer{
    margin-top: 10px;
    text-align: center;
    font-size: 12px;
    color: var(--muted);
    padding-top: 8px;
    border-top: 1px solid var(--ring);
  }
  .file-input-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .file-input-btn {
    flex: 1;
    min-width: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px;
    border: 1px dashed var(--ring);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    background: #0b1224;
  }
  .light-mode .file-input-btn {
    background: #ffffff;
  }
  .file-input-btn:hover {
    border-color: var(--secondary);
    background: rgba(59, 130, 246, 0.1);
  }
  .file-input-btn.has-file {
    border-color: var(--accent);
    background: rgba(34, 197, 94, 0.1);
  }
  .file-input-btn svg {
    width: 24px;
    height: 24px;
    margin-bottom: 6px;
  }
  .file-input-btn span {
    font-size: 12px;
    text-align: center;
  }
  .file-input-hidden {
    display: none;
  }
  .subject-select {
    max-height: 300px;
    overflow-y: auto;
  }
  .subject-category {
    font-weight: bold;
    color: var(--accent);
    padding: 8px 0 4px 0;
    border-top: 1px solid var(--ring);
    margin-top: 8px;
  }
  .file-preview {
    margin-top: 8px;
    padding: 8px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--accent);
    border-radius: 8px;
    font-size: 12px;
  }
  .file-preview-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
  }
  .file-preview-item button {
    background: var(--accent);
    border: none;
    color: white;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    cursor: pointer;
  }
  .problem-type-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .problem-type-btn {
    padding: 8px 12px;
    border: 1px solid var(--ring);
    background: transparent;
    color: var(--text);
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }
  .problem-type-btn:hover {
    border-color: var(--secondary);
    background: rgba(59, 130, 246, 0.1);
  }
  .problem-type-btn.active {
    border-color: var(--accent);
    background: rgba(34, 197, 94, 0.1);
    color: var(--accent);
  }
  /* Enhanced response styling */
  .response-content h3 {
    color: var(--accent);
    margin: 1.5em 0 0.8em 0;
    font-size: 1.3em;
   font-weight: 600;
    border-left: 4px solid var(--accent);
    padding-left: 12px;
  }
  .response-content h4 {
    color: var(--text);
    margin: 1.2em 0 0.6em 0;
    font-size: 1.1em;
    font-weight: 600;
  }
  .response-content strong {
    color: var(--accent);
    font-weight: 600;
  }
  .response-content ul {
    margin: 0.5em 0 0.5em 2em;
    padding: 0;
  }
  .response-content li {
    margin: 0.3em 0;
  }
  .response-content .highlight {
    background-color: rgba(red);
    border-left: 3px solid var(--highlight);
    padding: 0.8em;
    margin: 1em 0;
    border-radius: 6px;
  }
  .response-content .formula {
    background-color: rgba(59, 130, 246, 0.1);
    border-left: 3px solid var(--secondary);
    padding: 0.8em;
    margin: 1em 0;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    overflow-x: auto;
  }
  .response-content blockquote {
    border-left: 3px solid var(--muted);
    margin: 1em 0;
    padding: 0.5em 1em;
    color: var(--text);
    font-style: italic;
  }
  .response-content code {
    background-color: rgba(51, 65, 85, 0.3);
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
  }
  .light-mode .response-content code {
    background-color: rgba(226, 232, 240, 0.5);
  }
  .analysis-mode {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid var(--secondary);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .light-mode .analysis-mode {
    background: rgba(14, 165, 233, 0.08);
    border: 1px solid var(--secondary);
  }
  .analysis-mode-title {
    color: var(--secondary);
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 14px;
  }
  .error-message {
    color: #ef4444;
    padding: 12px;
    border: 1px solid #ef4444;
    border-radius: 8px;
    margin: 10px 0;
  }
</style>
</head>
<body>
  <div class="header-container">
    <div class="wrap">
      <div class="header-content">
        <div class="logo">
          <span>⚡SBI AI</span>
        </div>
        <div class="controls">
          <div class="lang-dropdown" id="langDropdown">
            <button class="icon-btn" title="Langue">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
              </svg>
            </button>
            <div class="lang-dropdown-content">
              <a href="#" data-lang="en">English</a>
              <a href="#" data-lang="fr">Français</a>
              <a href="#" data-lang="ar">العربية</a>
              <a href="#" data-lang="de">Deutsch</a>
              <a href="#" data-lang="ha">Hausa</a>
              <a href="#" data-lang="hi">हिन्दी</a>
              <a href="#" data-lang="ru">Русский</a>
            </div>
          </div>
          <button class="icon-btn" id="darkModeToggle" title="Mode sombre">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="main-header">
      <h1 id="mainTitle">Comment puis-je vous aider ?</h1>
    </div>

    <div class="grid grid-2">
      <section class="card">
        <div class="grid">
          <div class="row">
            <div>
              <label id="subjectLabel">Matière</label>
              <select id="subject" class="subject-select">
                <option value="Général">Général</option>
                <option class="subject-category" disabled>────── Sciences humaines et sociales ──────</option>
                <option value="Philosophie">Philosophie</option>
                <option value="Histoire">Histoire</option>
                <option value="Géographie">Géographie</option>
                <option value="Sociologie">Sociologie</option>
                <option value="Psychologie">Psychologie</option>
                <option value="Linguistique">Linguistique</option>
                <option value="Droit">Droit</option>
                <option value="Politique">Politique</option>
                <option value="Économie">Économie</option>
                <option value="Gestion">Gestion</option>
                <option value="Relations internationales">Relations internationales</option>
                <option value="Communication">Communication</option>
                <option class="subject-category" disabled>────── Théologie et études religieuses ──────</option>
                <option value="Coran">Coran</option>
                <option value="Religion comparée">Religion comparée</option>
                <option value="Bible">Bible</option>
                <option value="Hadiths">Hadiths</option>
                <option value="Vie des compagnons">La vie des compagnons</option>
                <option value="Histoire des prophètes">L'histoire des prophètes</option>
                <option class="subject-category" disabled>────── Sciences exactes et techniques ──────</option>
                <option value="Mathématiques">Mathématiques</option>
                <option value="Informatique">Informatique</option>
                <option value="Programmation">Programmation</option>
                <option value="HTML/CSS/JavaScript">HTML/ CSS/ JavaScript</option>
                <option value="Python">Python</option>
                <option value="C++">C++</option>
                <option value="PHP">PHP</option>
                <option value="Java">Java</option>
                <option value="Website creator">Website creator</option>
                <option value="App creator">App creator</option>
                <option value="Physique">Physique</option>
                <option value="Chimie">Chimie</option>
                <option value="Statistiques">Statistiques</option>
                <option class="subject-category" disabled>────── Sciences de la vie et de la santé ──────</option>
                <option value="Biologie">Biologie</option>
                <option value="Médecine">Médecine</option>
                <option value="Pharmacie">Pharmacie</option>
                <option value="Odontologie">Odontologie</option>
                <option value="Sciences infirmières">Sciences infirmières</option>
                <option class="subject-category" disabled>────── Ingénierie et sciences appliquées ──────</option>
                <option value="Ingénierie">Ingénierie</option>
                <option value="Architecture">Architecture</option>
                <option value="Agronomie">Agronomie</option>
                <option value="Électronique">Électronique</option>
                <option value="Génie civil">Génie civil</option>
                <option value="Énergie">Énergie</option>
                <option class="subject-category" disabled>────── Arts et création ──────</option>
                <option value="Musique">Musique</option>
                <option value="Théâtre">Théâtre</option>
                <option value="Cinéma">Cinéma</option>
                <option value="Arts plastiques">Arts plastiques</option>
                <option value="Design">Design</option>
                <option value="Histoire de l'art">Histoire de l'art</option>
                <option class="subject-category" disabled>────── Éducation ──────</option>
                <option value="Sciences de l'éducation">Sciences de l'éducation</option>
                <option value="Pédagogie">Pédagogie</option>
                <option value="Formation des enseignants">Formation des enseignants</option>
              </select>
            </div>
            <div>
              <label id="langResponseLabel">Langue de réponse</label>
              <select id="lang">
                <option value="English">English</option>
                <option value="French">Français</option>
                <option value="Arabic">العربية</option>
                <option value="German">Deutsch</option>
                <option value="Hausa">Hausa</option>
                <option value="Hindi">हिन्दी</option>
                <option value="Russian">Русский</option>
              </select>
            </div>
          </div>

          <div>
            <label for="modelSelector">Modèle IA</label>
            <select id="modelSelector"></select>
          </div>

          <div id="analysisMode" class="analysis-mode" style="display:none;">
            <div class="analysis-mode-title" id="analysisModeTitle">Mode d'analyse de problème activé</div>
            <div id="analysisModeDesc">L'IA analysera automatiquement vos fichiers pour identifier et résoudre les problèmes.</div>
            <div class="problem-type-selector" id="problemTypeSelector">
              <button class="problem-type-btn" data-type="math">Math</button>
              <button class="problem-type-btn" data-type="physics">Physique</button>
              <button class="problem-type-btn" data-type="chemistry">Chimie</button>
              <button class="problem-type-btn" data-type="text">Texte</button>
              <button class="problem-type-btn active" data-type="auto">Auto</button>
            </div>
          </div>

          <div>
            <label id="fileInputLabel">Fichiers pour analyse</label>
            <div class="file-input-container">
              <label class="file-input-btn" id="imageBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span id="imageBtnText">Image/Photo</span>
                <input type="file" id="imageInput" accept="image/*,.pdf" class="file-input-hidden" multiple>
              </label>
              <label class="file-input-btn" id="docBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span id="docBtnText">Document</span>
                <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.txt,.csv" class="file-input-hidden" multiple>
              </label>
            </div>
            <div class="tip" id="fileTip">Téléchargez des images de problèmes, exercices, ou documents pour une résolution automatique.</div>
            <div id="filePreview"></div>
          </div>

          <div>
            <label id="questionLabel">Question ou instructions supplémentaires (optionnel)</label>
            <textarea id="question" placeholder=""></textarea>
            <div class="footer">
              <span id="charCount" class="muted">0 caractères</span>
              <span id="tipText" class="muted">Laissez vide pour une analyse automatique complète.</span>
            </div>
          </div>

          <div class="toolbar">
            <button id="askBtn" class="btn">Analyser et résoudre</button>
            <button id="clearBtn" class="btn ghost">Effacer tout</button>
          </div>
        </div>
      </section>

      <section class="card">
        <label id="responseLabel">Analyse et solution</label>
        <div id="status" class="muted" style="min-height:18px;margin-bottom:8px;"></div>
        <div id="output" class="out response-content" style="min-height:220px;border-radius:6px;padding:14px;"></div>
        <div class="response-footer">
          Fait avec ⚡SBI
        </div>
        <div class="toolbar right" style="margin-top:10px">
          <button id="copyBtn" class="pill">Copier</button>
        </div>
      </section>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const apiConfigurations = {
    "gemini-2.5-PRO-exp": { apiKey: "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", modelName: "google/gemini-pro-1.5" },
    "gemini-2.0-flash-exp": { apiKey: "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", modelName: "google/gemini-flash-1.5" },
    "deepseek-r1-0528-qwen3-8b": { apiKey: "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", modelName: "deepseek/deepseek-chat" },
    "deepseek-r1-0528": { apiKey: "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", modelName: "deepseek/deepseek-chat" },
    "llama-3.3-8b-instruct": { apiKey: "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", modelName: "meta-llama/llama-3-8b-instruct" },
    "gpt-oss-20b": { apiKey: "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", modelName: "gpt-oss-20b" },
    "gemma-3n-e4b-it": { apiKey: "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", modelName: "google/gemma-2-9b-it" },
    "mistral-7b-instruct": { apiKey: "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", modelName: "mistralai/mistral-7b-instruct" },
    "deepseek-chat-v3-0324": { apiKey: "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", modelName: "deepseek/deepseek-chat" }
  };

  // CORRECTED: The full textElements object is now included.
  const textElements = {
    en: {
      mainTitle: "How can I help you solve problems?", subjectLabel: "Subject", langResponseLabel: "Response Language", questionLabel: "Additional question or instructions (optional)", questionPlaceholder: "Leave empty for complete automatic analysis", fileInputLabel: "Files for analysis", fileTip: "Upload images of problems, exercises, or documents for automatic solving.", askBtn: "Analyze and solve", clearBtn: "Clear all", copyBtn: "Copy", imageBtnText: "Image/Photo", docBtnText: "Document", analysisModeTitle: "Problem analysis mode activated", analysisModeDesc: "AI will automatically analyze your files to identify and solve problems.", responseLabel: "Analysis and solution", tipText: "Leave empty for complete automatic analysis.",
      subjectCategories: {"Sciences humaines et sociales": "Humanities and Social Sciences", "Théologie et études religieuses": "Theology and Religious Studies", "Sciences exactes et techniques": "Exact and Technical Sciences", "Sciences de la vie et de la santé": "Life and Health Sciences", "Ingénierie et sciences appliquées": "Engineering and Applied Sciences", "Arts et création": "Arts and Creativity", "Éducation": "Education"},
      subjects: {"Général": "General", "Philosophie": "Philosophy", "Histoire": "History", "Géographie": "Geography", "Sociologie": "Sociology", "Psychologie": "Psychology", "Linguistique": "Linguistics", "Droit": "Law", "Politique": "Politics", "Économie": "Economics", "Gestion": "Management", "Relations internationales": "International Relations", "Communication": "Communication", "Coran": "Quran", "Religion comparée": "Comparative Religion", "Bible": "Bible", "Hadiths": "Hadith", "Vie des compagnons": "Life of the Companions", "Histoire des prophètes": "History of the Prophets", "Mathématiques": "Mathematics", "Informatique": "Computer Science", "Programmation": "Programming", "HTML/CSS/JavaScript": "HTML/CSS/JavaScript", "Python": "Python", "C++": "C++", "PHP": "PHP", "Java": "Java", "Website creator": "Website Creation", "App creator": "App Creation", "Physique": "Physics", "Chimie": "Chemistry", "Statistiques": "Statistics", "Biologie": "Biology", "Médecine": "Medicine", "Pharmacie": "Pharmacy", "Odontologie": "Dentistry", "Sciences infirmières": "Nursing Sciences", "Ingénierie": "Engineering", "Architecture": "Architecture", "Agronomie": "Agronomy", "Électronique": "Electronics", "Génie civil": "Civil Engineering", "Énergie": "Energy", "Musique": "Music", "Théâtre": "Theatre", "Cinéma": "Cinema", "Arts plastiques": "Visual Arts", "Design": "Design", "Histoire de l'art": "Art History", "Sciences de l'éducation": "Educational Sciences", "Pédagogie": "Pedagogy", "Formation des enseignants": "Teacher Training"}
    },
    fr: {
      mainTitle: "Comment puis-je vous aider à résoudre des problèmes ?", subjectLabel: "Matière", langResponseLabel: "Langue de réponse", questionLabel: "Question ou instructions supplémentaires (optionnel)", questionPlaceholder: "Laissez vide pour une analyse automatique complète", fileInputLabel: "Fichiers pour analyse", fileTip: "Téléchargez des images de problèmes, exercices, ou documents pour une résolution automatique.", askBtn: "Analyser et résoudre", clearBtn: "Effacer tout", copyBtn: "Copier", imageBtnText: "Image/Photo", docBtnText: "Document", analysisModeTitle: "Mode d'analyse de problème activé", analysisModeDesc: "L'IA analysera automatiquement vos fichiers pour identifier et résoudre les problèmes.", responseLabel: "Analyse et solution", tipText: "Laissez vide pour une analyse automatique complète.",
      subjectCategories: {"Sciences humaines et sociales": "Sciences humaines et sociales", "Théologie et études religieuses": "Théologie et études religieuses", "Sciences exactes et techniques": "Sciences exactes et techniques", "Sciences de la vie et de la santé": "Sciences de la vie et de la santé", "Ingénierie et sciences appliquées": "Ingénierie et sciences appliquées", "Arts et création": "Arts et création", "Éducation": "Éducation"},
      subjects: {"Général": "Général", "Philosophie": "Philosophie", "Histoire": "Histoire", "Géographie": "Géographie", "Sociologie": "Sociologie", "Psychologie": "Psychologie", "Linguistique": "Linguistique", "Droit": "Droit", "Politique": "Politique", "Économie": "Économie", "Gestion": "Gestion", "Relations internationales": "Relations internationales", "Communication": "Communication", "Coran": "Coran", "Religion comparée": "Religion comparée", "Bible": "Bible", "Hadiths": "Hadiths", "Vie des compagnons": "La vie des compagnons", "Histoire des prophètes": "L'histoire des prophètes", "Mathématiques": "Mathématiques", "Informatique": "Informatique", "Programmation": "Programmation", "HTML/CSS/JavaScript": "HTML/CSS/JavaScript", "Python": "Python", "C++": "C++", "PHP": "PHP", "Java": "Java", "Website creator": "Création de sites web", "App creator": "Création d'applications", "Physique": "Physique", "Chimie": "Chimie", "Statistiques": "Statistiques", "Biologie": "Biologie", "Médecine": "Médecine", "Pharmacie": "Pharmacie", "Odontologie": "Odontologie", "Sciences infirmières": "Sciences infirmières", "Ingénierie": "Ingénierie", "Architecture": "Architecture", "Agronomie": "Agronomie", "Électronique": "Électronique", "Génie civil": "Génie civil", "Énergie": "Énergie", "Musique": "Musique", "Théâtre": "Théâtre", "Cinéma": "Cinéma", "Arts plastiques": "Arts plastiques", "Design": "Design", "Histoire de l'art": "Histoire de l'art", "Sciences de l'éducation": "Sciences de l'éducation", "Pédagogie": "Pédagogie", "Formation des enseignants": "Formation des enseignants"}
    },
    ar: {
      mainTitle: "كيف يمكنني مساعدتك في حل المشاكل؟", subjectLabel: "المادة", langResponseLabel: "لغة الرد", questionLabel: "سؤال أو تعليمات إضافية (اختياري)", questionPlaceholder: "اتركه فارغاً للتحليل التلقائي الكامل", fileInputLabel: "ملفات للتحليل", fileTip: "قم بتحميل صور المشاكل أو التمارين أو المستندات للحل التلقائي.", askBtn: "تحليل وحل", clearBtn: "مسح الكل", copyBtn: "نسخ", imageBtnText: "صورة", docBtnText: "مستند", analysisModeTitle: "تم تفعيل وضع تحليل المشاكل", analysisModeDesc: "سيقوم الذكاء الاصطناعي بتحليل ملفاتك تلقائياً لتحديد وحل المشاكل.", responseLabel: "التحليل والحل", tipText: "اتركه فارغاً للتحليل التلقائي الكامل.",
      subjectCategories: {"Sciences humaines et sociales": "العلوم الإنسانية والاجتماعية", "Théologie et études religieuses": "اللاهوت والدراسات الدينية", "Sciences exactes et techniques": "العلوم الدقيقة والتقنية", "Sciences de la vie et de la santé": "علوم الحياة والصحة", "Ingénierie et sciences appliquées": "الهندسة والعلوم التطبيقية", "Arts et création": "الفنون والإبداع", "Éducation": "التعليم"},
      subjects: {"Général": "عام", "Philosophie": "فلسفة", "Histoire": "تاريخ", "Géographie": "جغرافيا", "Sociologie": "علم اجتماع", "Psychologie": "علم نفس", "Linguistique": "لسانيات", "Droit": "قانون", "Politique": "سياسة", "Économie": "اقتصاد", "Gestion": "إدارة", "Relations internationales": "علاقات دولية", "Communication": "اتصال", "Coran": "القرآن الكريم", "Religion comparée": "مقارنة الأديان", "Bible": "الكتاب المقدس", "Hadiths": "الحديث الشريف", "Vie des compagnons": "حياة الصحابة", "Histoire des prophètes": "قصص الأنبياء", "Mathématiques": "رياضيات", "Informatique": "علوم الحاسوب", "Programmation": "برمجة", "HTML/CSS/JavaScript": "HTML/CSS/JavaScript", "Python": "بايثون", "C++": "C++", "PHP": "PHP", "Java": "جافا", "Website creator": "إنشاء مواقع الويب", "App creator": "إنشاء التطبيقات", "Physique": "فيزياء", "Chimie": "كيمياء", "Statistiques": "إحصاء", "Biologie": "أحياء", "Médecine": "طب", "Pharmacie": "صيدلة", "Odontologie": "طب الأسنان", "Sciences infirmières": "علوم التمريض", "Ingénierie": "هندسة", "Architecture": "عمارة", "Agronomie": "زراعة", "Électronique": "إلكترونيات", "Génie civil": "هندسة مدنية", "Énergie": "طاقة", "Musique": "موسيقى", "Théâtre": "مسرح", "Cinéma": "سينما", "Arts plastiques": "فنون تشكيلية", "Design": "تصميم", "Histoire de l'art": "تاريخ الفن", "Sciences de l'éducation": "علوم التربية", "Pédagogie": "علم التربية", "Formation des enseignants": "تكوين المدرسين"}
    },
    de: {
      mainTitle: "Wie kann ich Ihnen bei der Lösung von Problemen helfen?", subjectLabel: "Fach", langResponseLabel: "Antwortsprache", questionLabel: "Zusätzliche Frage oder Anweisungen (optional)", questionPlaceholder: "Für eine vollständige automatische Analyse leer lassen", fileInputLabel: "Dateien zur Analyse", fileTip: "Laden Sie Bilder von Problemen, Übungen oder Dokumenten zur automatischen Lösung hoch.", askBtn: "Analysieren und lösen", clearBtn: "Alles löschen", copyBtn: "Kopieren", imageBtnText: "Bild/Foto", docBtnText: "Dokument", analysisModeTitle: "Problemanalysemodus aktiviert", analysisModeDesc: "Die KI analysiert Ihre Dateien automatisch, um Probleme zu identifizieren und zu lösen.", responseLabel: "Analyse und Lösung", tipText: "Für eine vollständige automatische Analyse leer lassen.",
      subjectCategories: {"Sciences humaines et sociales": "Geistes- und Sozialwissenschaften", "Théologie et études religieuses": "Theologie und Religionswissenschaft", "Sciences exactes et techniques": "Exakte und technische Wissenschaften", "Sciences de la vie et de la santé": "Lebens- und Gesundheitswissenschaften", "Ingenieurwesen und angewandte Wissenschaften": "Ingenieurwesen und angewandte Wissenschaften", "Arts et création": "Kunst und Kreativität", "Éducation": "Bildung"},
      subjects: {"Général": "Allgemein", "Philosophie": "Philosophie", "Histoire": "Geschichte", "Géographie": "Geographie", "Sociologie": "Soziologie", "Psychologie": "Psychologie", "Linguistique": "Sprachwissenschaft", "Droit": "Recht", "Politique": "Politik", "Économie": "Wirtschaft", "Gestion": "Management", "Relations internationales": "Internationale Beziehungen", "Communication": "Kommunikation", "Coran": "Koran", "Religion comparée": "Vergleichende Religionswissenschaft", "Bible": "Bibel", "Hadiths": "Hadith", "Vie des compagnons": "Leben der Gefährten", "Histoire des prophètes": "Geschichte der Propheten", "Mathématiques": "Mathematik", "Informatique": "Informatik", "Programmation": "Programmierung", "HTML/CSS/JavaScript": "HTML/CSS/JavaScript", "Python": "Python", "C++": "C++", "PHP": "PHP", "Java": "Java", "Website creator": "Website-Erstellung", "App creator": "App-Erstellung", "Physique": "Physik", "Chimie": "Chemie", "Statistiques": "Statistik", "Biologie": "Biologie", "Médecine": "Medizin", "Pharmacie": "Pharmazie", "Odontologie": "Zahnmedizin", "Sciences infirmières": "Pflegewissenschaft", "Ingénierie": "Ingenieurwesen", "Architecture": "Architektur", "Agronomie": "Agronomie", "Électronique": "Elektronik", "Génie civil": "Bauingenieurwesen", "Énergie": "Energie", "Musique": "Musik", "Théâtre": "Theater", "Cinéma": "Kino", "Arts plastiques": "Bildende Kunst", "Design": "Design", "Histoire de l'art": "Kunstgeschichte", "Sciences de l'éducation": "Erziehungswissenschaften", "Pédagogie": "Pädagogik", "Formation des enseignants": "Lehrerbildung"}
    },
    ha: {
      mainTitle: "Ta yaya zan iya taimaka maka warware matsaloli?", subjectLabel: "Darasi", langResponseLabel: "Harshen Amsa", questionLabel: "Ƙarin tambaya ko umarni (na zaɓi)", questionPlaceholder: "A bar wofi don cikakken bincike na atomatik", fileInputLabel: "Fayiloli don bincike", fileTip: "Shigar da hotunan matsaloli, atisaye, ko takardu don warwarewa ta atomatik.", askBtn: "Bincika da warware", clearBtn: "Goge duka", copyBtn: "Kwafi", imageBtnText: "Hoto", docBtnText: "Takarda", analysisModeTitle: "Yanayin nazarin matsala an kunna", analysisModeDesc: "AI zai bincika fayilolinku ta atomatik don ganowa da warware matsaloli.", responseLabel: "Bincike da Magani", tipText: "A bar wofi don cikakken bincike na atomatik.",
      subjectCategories: {"Sciences humaines et sociales": "Kimiyyar Dan Adam da Zamantakewa", "Théologie et études religieuses": "Ilimin Addini da Nazarin Addinai", "Sciences exactes et techniques": "Kimiyyar Gaskiya da Fasaha", "Sciences de la vie et de la santé": "Kimiyyar Rayuwa da Lafiya", "Ingénierie et sciences appliquées": "Injiniyanci da Kimiyyar Aiki", "Arts et création": "Fasaha da Ƙirƙira", "Éducation": "Ilimi"},
      subjects: {"Général": "Gabaɗaya", "Philosophie": "Falsafa", "Histoire": "Tarihi", "Géographie": "Labarin Ƙasa", "Sociologie": "Ilimin Zamantakewa", "Psychologie": "Ilimin Halayyar Ɗan Adam", "Linguistique": "Ilimin Harshe", "Droit": "Doka", "Politique": "Siyasa", "Économie": "Tattalin Arziki", "Gestion": "Gudanarwa", "Relations internationales": "Dangantakar Ƙasa da Ƙasa", "Communication": "Sadarwa", "Coran": "Al-Qur'ani", "Religion comparée": "Kwatancen Addinai", "Bible": "Littafi Mai Tsarki", "Hadiths": "Hadisi", "Vie des compagnons": "Rayuwar Sahabbai", "Histoire des prophètes": "Tarihin Annabawa", "Mathématiques": "Lissafi", "Informatique": "Kimiyyar Kwamfuta", "Programmation": "Shirye-shirye", "HTML/CSS/JavaScript": "HTML/CSS/JavaScript", "Python": "Python", "C++": "C++", "PHP": "PHP", "Java": "Java", "Website creator": "Gina Yanar Gizo", "App creator": "Ƙirƙirar Manhaja", "Physique": "Fiziks", "Chimie": "Kimiyya", "Statistiques": "Ƙididdiga", "Biologie": "Ilimin Halittu", "Médecine": "Magani", "Pharmacie": "Kimiyyar Magunguna", "Odontologie": "Ilimin Haƙori", "Sciences infirmières": "Kimiyyar Jinya", "Ingénierie": "Injiniyanci", "Architecture": "Gine-gine", "Agronomie": "Noma", "Électronique": "Kayan Lantarki", "Génie civil": "Injiniyancin Jama'a", "Énergie": "Makashi", "Musique": "Waƙa", "Théâtre": "Wasan Kwaikwayo", "Cinéma": "Fim", "Arts plastiques": "Zane-zane", "Design": "Zane", "Histoire de l'art": "Tarihin Fasaha", "Sciences de l'éducation": "Kimiyyar Ilimi", "Pédagogie": "Hanyoyin Koyarwa", "Formation des enseignants": "Horar da Malamai"}
    },
    hi: {
      mainTitle: "मैं आपकी समस्याएँ हल करने में कैसे मदद कर सकता हूँ?", subjectLabel: "विषय", langResponseLabel: "प्रतिक्रिया की भाषा", questionLabel: "अतिरिक्त प्रश्न या निर्देश (वैकल्पिक)", questionPlaceholder: "पूर्ण स्वचालित विश्लेषण के लिए खाली छोड़ दें", fileInputLabel: "विश्लेषण के लिए फ़ाइलें", fileTip: "स्वचालित समाधान के लिए समस्याओं, अभ्यासों या दस्तावेज़ों की छवियाँ अपलोड करें।", askBtn: "विश्लेषण करें और हल करें", clearBtn: "सब साफ़ करें", copyBtn: "कॉपी करें", imageBtnText: "छवि/फोटो", docBtnText: "दस्तावेज़", analysisModeTitle: "समस्या विश्लेषण मोड सक्रिय", analysisModeDesc: "एआई समस्याओं की पहचान करने और उन्हें हल करने के लिए आपकी फ़ाइलों का स्वचालित रूप से विश्लेषण करेगा।", responseLabel: "विश्लेषण और समाधान", tipText: "पूर्ण स्वचालित विश्लेषण के लिए खाली छोड़ दें।",
      subjectCategories: {"Sciences humaines et sociales": "मानविकी और सामाजिक विज्ञान", "Théologie et études religieuses": "धर्मशास्त्र और धार्मिक अध्ययन", "Sciences exactes et techniques": "सटीक और तकनीकी विज्ञान", "Sciences de la vie et de la santé": "जीवन और स्वास्थ्य विज्ञान", "Ingénierie et sciences appliquées": "इंजीनियरिंग और अनुप्रयुक्त विज्ञान", "Arts et création": "कला और रचनात्मकता", "Éducation": "शिक्षा"},
      subjects: {"Général": "सामान्य", "Philosophie": "दर्शन", "Histoire": "इतिहास", "Géographie": "भूगोल", "Sociologie": "समाजशास्त्र", "Psychologie": "मनोविज्ञान", "Linguistique": "भाषा विज्ञान", "Droit": "कानून", "Politique": "राजनीति", "Économie": "अर्थशास्त्र", "Gestion": "प्रबंधन", "Relations internationales": "अंतर्राष्ट्रीय संबंध", "Communication": "संचार", "Coran": "कुरान", "Religion comparée": "तुलनात्मक धर्म", "Bible": "बाइबिल", "Hadiths": "हदीस", "Vie des compagnons": "सहाबा का जीवन", "Histoire des prophètes": "पैगंबरों का इतिहास", "Mathématiques": "गणित", "Informatique": "कंप्यूटर विज्ञान", "Programmation": "प्रोग्रामिंग", "HTML/CSS/JavaScript": "एचटीएमएल/सीएसएस/जावास्क्रिप्ट", "Python": "पाइथन", "C++": "सी++", "PHP": "पीएचपी", "Java": "जावा", "Website creator": "वेबसाइट निर्माण", "App creator": "ऐप निर्माण", "Physique": "भौतिकी", "Chimie": "रसायन विज्ञान", "Statistiques": "सांख्यिकी", "Biologie": "जीव विज्ञान", "Médecine": "चिकित्सा", "Pharmacie": "फार्मेसी", "Odontologie": "दंत चिकित्सा", "Sciences infirmières": "नर्सिंग विज्ञान", "Ingénierie": "इंजीनियरिंग", "Architecture": "वास्तुकला", "Agronomie": "कृषि विज्ञान", "Électronique": "इलेक्ट्रॉनिक्स", "Génie civil": "सिविल इंजीनियरिंग", "Énergie": "ऊर्जा", "Musique": "संगीत", "Théâtre": "थिएटर", "Cinéma": "सिनेमा", "Arts plastiques": "दृश्य कला", "Design": "डिज़ाइन", "Histoire de l'art": "कला का इतिहास", "Sciences de l'éducation": "शिक्षा विज्ञान", "Pédagogie": "शिक्षाशास्त्र", "Formation des enseignants": "शिक्षक प्रशिक्षण"}
    },
    ru: {
      mainTitle: "Как я могу помочь вам решить проблемы?", subjectLabel: "Предмет", langResponseLabel: "Язык ответа", questionLabel: "Дополнительный вопрос или инструкции (необязательно)", questionPlaceholder: "Оставьте пустым для полного автоматического анализа", fileInputLabel: "Файлы для анализа", fileTip: "Загрузите изображения задач, упражнений или документов для автоматического решения.", askBtn: "Анализировать и решить", clearBtn: "Очистить все", copyBtn: "Копировать", imageBtnText: "Изображение/Фото", docBtnText: "Документ", analysisModeTitle: "Режим анализа проблем активирован", analysisModeDesc: "ИИ автоматически проанализирует ваши файлы для выявления и решения проблем.", responseLabel: "Анализ и решение", tipText: "Оставьте пустым для полного автоматического анализа.",
      subjectCategories: {"Sciences humaines et sociales": "Гуманитарные и социальные науки", "Théologie et études religieuses": "Теология и религиоведение", "Sciences exactes et techniques": "Точные и технические науки", "Sciences de la vie et de la santé": "Науки о жизни и здоровье", "Ingénierie et sciences appliquées": "Инженерия и прикладные науки", "Arts et création": "Искусство и творчество", "Éducation": "Образование"},
      subjects: {"Général": "Общий", "Philosophie": "Философия", "Histoire": "История", "Géographie": "География", "Sociologie": "Социология", "Psychologie": "Психология", "Linguistique": "Лингвистика", "Droit": "Право", "Politique": "Политика", "Économie": "Экономика", "Gestion": "Управление", "Relations internationales": "Международные отношения", "Communication": "Коммуникация", "Coran": "Коран", "Religion comparée": "Сравнительное религиоведение", "Bible": "Библия", "Hadiths": "Хадисы", "Vie des compagnons": "Жизнь сподвижников", "Histoire des prophètes": "История пророков", "Mathématiques": "Математика", "Informatique": "Информатика", "Programmation": "Программирование", "HTML/CSS/JavaScript": "HTML/CSS/JavaScript", "Python": "Python", "C++": "C++", "PHP": "PHP", "Java": "Java", "Website creator": "Создание веб-сайтов", "App creator": "Создание приложений", "Physique": "Физика", "Chimie": "Химия", "Statistiques": "Статистика", "Биология": "Биология", "Médecine": "Медицина", "Pharmacie": "Фармацевтика", "Odontologie": "Стоматология", "Sciences infirmières": "Сестринское дело", "Инженерия": "Инженерия", "Architecture": "Архитектура", "Agronomie": "Агрономия", "Électronique": "Электроника", "Génie civil": "Гражданское строительство", "Énergie": "Энергетика", "Musique": "Музыка", "Théâtre": "Театр", "Cinéma": "Кино", "Arts plastiques": "Изобразительное искусство", "Design": "Дизайн", "Histoire de l'art": "История искусств", "Sciences de l'éducation": "Педагогические науки", "Pédagogie": "Педагогика", "Formation des enseignants": "Подготовка учителей"}
    }
  };

  let selectedFiles = [];
  let selectedProblemType = 'auto';
  let currentLang = 'fr';

  function updateLanguage(lang) {
    const texts = textElements[lang] || textElements.fr;
    currentLang = lang;

    $('mainTitle').textContent = texts.mainTitle;
    $('subjectLabel').textContent = texts.subjectLabel;
    $('langResponseLabel').textContent = texts.langResponseLabel;
    $('questionLabel').textContent = texts.questionLabel;
    $('question').placeholder = texts.questionPlaceholder;
    $('fileInputLabel').textContent = texts.fileInputLabel;
    $('fileTip').textContent = texts.fileTip;
    $('responseLabel').textContent = texts.responseLabel;
    $('askBtn').textContent = texts.askBtn;
    $('clearBtn').textContent = texts.clearBtn;
    $('copyBtn').textContent = texts.copyBtn;
    $('imageBtnText').textContent = texts.imageBtnText;
    $('docBtnText').textContent = texts.docBtnText;
    $('analysisModeTitle').textContent = texts.analysisModeTitle;
    $('analysisModeDesc').textContent = texts.analysisModeDesc;
    $('tipText').textContent = texts.tipText;

    updateSubjectDropdown(lang);
    updateFilePreview();
    $('langDropdown').classList.remove('active');
  }

  function updateSubjectDropdown(lang) {
    const texts = textElements[lang] || textElements.fr;
    const subjectSel = $('subject');
    for (const key in texts.subjects) {
      const option = subjectSel.querySelector(`option[value="${key}"]`);
      if (option) {
        option.textContent = texts.subjects[key];
      }
    }
    const categoryOriginals = ["Sciences humaines et sociales", "Théologie et études religieuses", "Sciences exactes et techniques", "Sciences de la vie et de la santé", "Ingénierie et sciences appliquées", "Arts et création", "Éducation"];
    const categoryHeaders = subjectSel.querySelectorAll('option.subject-category');
    categoryHeaders.forEach((header, index) => {
        const originalKey = categoryOriginals[index];
        if (originalKey && texts.subjectCategories[originalKey]) {
            header.textContent = `────── ${texts.subjectCategories[originalKey]} ──────`;
        }
    });
  }

  function populateModelSelector() {
    const modelSelector = $('modelSelector');
    for (const modelId in apiConfigurations) {
        const option = document.createElement('option');
        option.value = modelId;
        option.textContent = modelId;
        modelSelector.appendChild(option);
    }
  }

  function setStatusLoading(msg='Analyse en cours…'){
    $('status').innerHTML = `<span class="spinner"></span> <span style="margin-left:8px">${msg}</span>`;
  }

  function setStatus(msg=''){ $('status').textContent = msg; }

  function toast(msg){ setStatus(msg); setTimeout(()=>setStatus(''), 1600); }

  async function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function updateFilePreview() {
    const filePreview = $('filePreview');
    if (selectedFiles.length === 0) {
      filePreview.innerHTML = '';
      $('analysisMode').style.display = 'none';
      $('imageBtn').classList.remove('has-file');
      $('docBtn').classList.remove('has-file');
      return;
    }

    $('analysisMode').style.display = 'block';
    const imageFiles = selectedFiles.filter(f => f.type.startsWith('image/') || f.type === 'application/pdf');
    const docFiles = selectedFiles.filter(f => !f.type.startsWith('image/') && f.type !== 'application/pdf');

    $('imageBtn').classList.toggle('has-file', imageFiles.length > 0);
    $('docBtn').classList.toggle('has-file', docFiles.length > 0);

    filePreview.innerHTML = selectedFiles.map((file, index) => {
      const fileType = file.type.startsWith('image/') ? '📷' : file.type === 'application/pdf' ? '📄' : '📋';
      return `<div class="file-preview-item"><span>${fileType} ${file.name}</span><button onclick="removeFile(${index})">✕</button></div>`;
    }).join('');
  }

  function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFilePreview();
  }
  window.removeFile = removeFile;

  async function callAIModel(modelId, question, subject, answerLanguage, files, problemType){
    const config = apiConfigurations[modelId];
    if (!config || !config.apiKey) {
        throw new Error(`API key not configured for model ${modelId}.`);
    }

    const endpoint = 'https://openrouter.ai/api/v1/chat/completions';
    
    const systemPrompt = `Your entire response MUST be in the following language: ${answerLanguage}. You are an expert educational assistant for the subject of ${subject}. Your mission is to automatically solve all problems in the provided files. STEPS: 1. IDENTIFY all problems. 2. CLASSIFY problem type. 3. RESOLVE step-by-step with clear explanations. 4. VERIFY answers. ${problemType !== 'auto' ? `Focus on: ${problemType}` : ''} STRUCTURE: ### 🔍 Analysis, ### 📋 Problems, ### ✅ Solutions, ### 🎯 Summary. Use clear headings and format formulas in code blocks.`;

    const userPromptText = question.trim() || `No specific instructions - perform a complete automatic analysis.`;
    const userContent = [{ type: "text", text: userPromptText }];

    for (const file of files) {
      if (file.type.startsWith('image/')) {
        try {
          userContent.push({ type: "image_url", image_url: { url: await fileToDataUrl(file) } });
        } catch (err) {
          throw new Error(`Error processing file ${file.name}`);
        }
      }
    }

    const body = {
      model: config.modelName,
      messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userContent } ],
      max_tokens: 4096
    };

    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const errorData = await res.json();
        throw new Error(`API Error ${res.status}: ${errorData.error.message || 'Unknown error'}`);
      }
      const data = await res.json();
      return data?.choices?.[0]?.message?.content || 'No response received.';
    } catch (err) {
      throw new Error(`API communication error: ${err.message}`);
    }
  }

  const subjectSel = $('subject');
  const langSel = $('lang');
  const qArea = $('question');
  const out = $('output');
  const imageInput = $('imageInput');
  const documentInput = $('documentInput');
  const langDropdown = $('langDropdown');
  const problemTypeSelector = $('problemTypeSelector');
  const modelSelector = $('modelSelector');
  const darkModeToggle = $('darkModeToggle');
  const askBtn = $('askBtn');

  const updateCount = () => $('charCount').textContent = `${(qArea.value || '').length} characters`;
  qArea.addEventListener('input', updateCount);

  $('clearBtn').onclick = () => {
    qArea.value = '';
    updateCount();
    out.textContent = '';
    setStatus('');
    imageInput.value = '';
    documentInput.value = '';
    selectedFiles = [];
    updateFilePreview();
  };

  $('copyBtn').onclick = async () => {
    if (!out.textContent.trim()) { toast('Nothing to copy'); return; }
    try {
      await navigator.clipboard.writeText(out.textContent);
      toast('Copied!');
    } catch (err) {
      toast('Copy failed');
    }
  };

  imageInput.addEventListener('change', (e) => {
    selectedFiles.push(...e.target.files);
    updateFilePreview();
  });

  documentInput.addEventListener('change', (e) => {
    selectedFiles.push(...e.target.files);
    updateFilePreview();
  });

  problemTypeSelector.addEventListener('click', (e) => {
    if (e.target.classList.contains('problem-type-btn')) {
      problemTypeSelector.querySelector('.active').classList.remove('active');
      e.target.classList.add('active');
      selectedProblemType = e.target.dataset.type;
    }
  });

  askBtn.onclick = async () => {
    if (selectedFiles.length === 0 && !qArea.value.trim()) {
      toast('Please upload a file or ask a question.');
      return;
    }
    askBtn.disabled = true;
    out.innerHTML = '';
    setStatusLoading('Analyzing and solving...');
    try {
      const answer = await callAIModel(modelSelector.value, qArea.value, subjectSel.options[subjectSel.selectedIndex].text, langSel.value, selectedFiles, selectedProblemType);
      out.innerHTML = answer
          .replace(/### (.*)/g, '<h3>$1</h3>')
          .replace(/## (.*)/g, '<h4>$1</h4>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/```([\s\S]*?)```/gs, '<div class="formula">$1</div>')
          .replace(/^\* (.*)/gm, '<li>$1</li>')
          .replace(/(<\/li>\n)(?!<li>)/g, '</li></ul>')
          .replace(/(<li>[\s\S]*?<\/li>)/s, '<ul>$1');
      setStatus('✅ Analysis complete.');
    } catch(err) {
      out.innerHTML = `<div class="error-message"><strong>Error:</strong> ${err.message}</div>`;
      setStatus('❌ Error during analysis.');
    } finally {
      askBtn.disabled = false;
    }
  };

  qArea.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      askBtn.click();
    }
  });

  let isDarkMode = !document.body.classList.contains('light-mode');
  darkModeToggle.addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('light-mode', !isDarkMode);
    darkModeToggle.innerHTML = isDarkMode
      ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>`
      : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>`;
  });

  const langButton = langDropdown.querySelector('.icon-btn');
  langDropdown.querySelectorAll('.lang-dropdown-content a').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      updateLanguage(e.target.getAttribute('data-lang'));
    });
  });

  langButton.addEventListener('click', (e) => {
    e.stopPropagation();
    langDropdown.classList.toggle('active');
  });

  document.addEventListener('click', (e) => {
    if (!langDropdown.contains(e.target)) {
      langDropdown.classList.remove('active');
    }
  });

  updateCount();
  populateModelSelector();
  updateLanguage('fr');
</script>
</body>
</html>
